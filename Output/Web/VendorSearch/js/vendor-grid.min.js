Ext.define("Ext.ux.form.SearchField",{extend:"Ext.form.field.Trigger",alias:"widget.searchfield",trigger1Cls:Ext.baseCSSPrefix+"form-clear-trigger",trigger2Cls:Ext.baseCSSPrefix+"form-search-trigger",paramName:"query",initComponent:function(){var a=this;a.callParent(arguments);a.on("specialkey",function(b,c){if(c.getKey()===c.ENTER){a.onTrigger2Click()}},a)},afterRender:function(){var a=this;a.callParent();a.triggerEl.item(0).setDisplayed("none")},onTrigger1Click:function(){var a=this;if(a.hasSearch){a.setValue("");a.doSearch();a.triggerEl.item(0).setDisplayed("none")}},onTrigger2Click:function(){var a=this,b=a.getValue();if(b.length<1){a.hasSearch=false;a.onTrigger1Click();return}a.doSearch()},reloadStore:function(){var a=this.store;a.proxy.extraParams.start=0;a.currentPage=1;a.load();delete a.proxy.extraParams.start},search:function(a){var b=this;b.setValue(a);b.doSearch()},doSearch:function(){var a=this;a.store.getProxy().extraParams[a.paramName]=a.getValue();a.reloadStore();a.hasSearch=true;a.triggerEl.item(0).setDisplayed("block");a.doComponentLayout()}});OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";Ext.Ajax.cors=true;Ext.define("MapWindow",{extend:"Ext.Window",title:"Map",width:500,height:400,mapWidth:5120,mapHeight:4088,mapName:"FELUCCA",minZoom:0,maxZoom:6,defaultZoom:5,closeAction:"hide",html:'<div id="map"></div><div id="subheader">Generated by <a href="http://www.maptiler.org/">MapTiler</a>/<a href="http://www.klokan.cz/projects/gdal2tiles/">GDAL2Tiles</a>, Copyright © 2008 <a href="http://www.klokan.cz/">Klokan Petr Pridal</a>,  <a href="http://www.gdal.org/">GDAL</a> & <a href="http://www.osgeo.org/">OSGeo</a> <a href="http://code.google.com/soc/">GSoC</a></div>',initComponent:function(){var a=this;a.callParent();a.on("afterrender",a.initMap,a)},initMap:function(){var a=this,b={controls:[],maxExtent:new OpenLayers.Bounds(0,0,a.mapWidth,a.mapHeight),maxResolution:32,numZoomLevels:a.maxZoom-a.minZoom+1,url:"map/"},c=new OpenLayers.Bounds(0,0,a.mapWidth,a.mapHeight),d=new OpenLayers.Layer.TMS(a.mapName,"",{url:"",serviceVersion:".",layername:".",alpha:false,type:"jpg",getURL:a.overlay_getTileURL}),e=new OpenLayers.Control.MousePosition({formatOutput:function(b){var c=Math.min(Math.max(0,a.mapHeight-b.lat),a.mapHeight);c+=", "+Math.min(Math.max(0,b.lon),a.mapWidth);return c}});a.map=new OpenLayers.Map("map",b);a.map.addLayer(d);a.map.zoomToExtent(c);a.map.addControl(new OpenLayers.Control.PanZoomBar);a.map.addControl(new OpenLayers.Control.MouseDefaults);a.map.addControl(new OpenLayers.Control.KeyboardDefaults);a.map.addControl(e);a.updateCenter();a.updateLocs();Ext.Ajax.request({url:"map/info/locations.txt",success:function(b){var c,d=new OpenLayers.Layer.Markers("Houses"),e=new OpenLayers.Size(19,16),f=new OpenLayers.Pixel(-(e.w/2),-e.h),g=new OpenLayers.Icon("map/icons/icon_city.gif",e,f),h=new OpenLayers.Size(19,20),i=new OpenLayers.Pixel(-(h.w/2),-h.h),j=new OpenLayers.Icon("map/icons/icon_skull.gif",h,i),k,l=Ext.decode(b.responseText,true);a.map.addLayer(d);for(k=0;0<l.length;++k){c=l[k];a.addMarkerWithPopup(d,c.type=="TOWN"?g:j,c.lon,c.lat,c.name)}},scope:a})},updateCenter:function(){var a=this,b=new OpenLayers.LonLat(a.lon,a.mapHeight-a.lat);a.map.setCenter(b,a.defaultZoom,false,true)},updateLocs:function(){var a=this;if(a.markers){a.map.removeLayer(a.markers);a.markers.destroy();a.markers=null}a.markers=new OpenLayers.Layer.Markers("Vendors");a.map.addLayer(a.markers);for(i=0,len=a.locs.length;i<len;i++){var b=a.locs.getAt(i),c=new OpenLayers.Size(21,25),d=new OpenLayers.Pixel(-(c.w/2),-c.h),e=new OpenLayers.Icon("http://www.openlayers.org/dev/img/marker.png",c,d);a.addMarkerWithPopup(a.markers,e,b.lat,b.lon,b.name)}},addMarkerWithPopup:function(a,b,c,d,e){var f=this,g=new OpenLayers.Marker(new OpenLayers.LonLat(c,f.mapHeight-d),b.clone());a.addMarker(g);g.events.register("mouseover",g,function(a){popup=new OpenLayers.Popup("thepopup",new OpenLayers.LonLat(c,f.mapHeight-d),new OpenLayers.Size(200,200),e,false);popup.autoSize=true;popup.maxSize=new OpenLayers.Size(200,200);popup.setBorder("1px solid #967212");f.map.addPopup(popup)});g.events.register("mouseout",g,function(a){f.map.removePopup(popup);popup.destroy();popup=null})},overlay_getTileURL:function(a){var b=this,c=b.map,d=c.getResolution(),e=Math.round((a.left-c.maxExtent.left)/(d*c.tileSize.w)),f=Math.round((a.bottom-c.maxExtent.bottom)/(d*c.tileSize.h)),g=c.getZoom();if(e>=0&&f>=0){return c.url+g+"/"+e+"/"+f+"."+b.type}else{return"http://www.maptiler.org/img/none.png"}}});Ext.define("VendorGrid",{extend:"Ext.grid.Panel",alias:"widget.vendorgrid",loadMask:true,bodyCls:"vendor-grid-body",overCellCls:"vendor-col-hover",stripeRows:false,clickableCols:[0,1,2,6,7],url:"http://game.in-uo.net:2595/vendorItems",initComponent:function(){var a=this;a.colModel={xtype:"headercontainer",baseCls:"vendor-grid-header-ct",items:[{text:"Vendor Name",dataIndex:"VendorName"},{text:"Name",dataIndex:"Name",flex:2,renderer:a.columnRenderer},{text:"Description",dataIndex:"Description",flex:2,renderer:a.columnRenderer},{text:"Amount",dataIndex:"Amount"},{text:"Price",dataIndex:"Price"},{text:"Price Per",dataIndex:"PricePer"},{text:"Location",dataIndex:"Location",flex:1,renderer:a.columnRenderer},{text:"Owner",dataIndex:"OwnerName"}]};a.store=Ext.create("Ext.data.Store",{fields:["Amount","Description","Location","Name","OwnerName","VendorName",{name:"PricePer",convert:a.formatPrice},{name:"Price",convert:a.formatPrice}],pageSize:30,sorters:[{property:"VendorName",direction:"ASC"}],proxy:{type:"jsonp",url:a.url,simpleSortMode:true,reader:{type:"json",root:"data",totalProperty:"count"}},remoteSort:true});a.tbar={componentCls:"vendor-grid-tb",items:[{xtype:"searchfield",fieldLabel:"Search",labelWidth:50,width:400,paramName:"q",store:a.store},"You can also click on a vendor/owner name, item name, or description to perform a search"]};a.bbar=Ext.create("Ext.PagingToolbar",{defaults:{overCls:""},componentCls:"vendor-grid-tb",store:a.store,displayInfo:true,displayMsg:"Displaying Items {0} - {1} of {2}",emptyMsg:"No items to display"});a.viewConfig={emptyText:"<div class='vendor-grid-empty'>No Items to Display</div>",deferEmptyText:false,componentCls:"vendor-grid-view",getRowClass:function(){return"vendor-grid-row"},disableSelection:true};a.callParent();a.on("cellclick",a.onCellClick,a);a.on("itemmouseenter",a.onMouseEnter,a);a.on("itemmouseleave",a.onMouseLeave,a);a.on("afterrender",a.onLoad,a,{single:true})},onLoad:function(){this.store.loadPage(1)},onCellClick:function(a,b,c,d){var e=this,f;if(Ext.Array.contains(e.clickableCols,c)){f=d.get(e.columns[c].dataIndex);if(c==6){e.openMap(f)}else if(!Ext.isEmpty(f)){e.query("searchfield")[0].search(f)}}},onMouseEnter:function(a,b,c,d,e){var f=this,g=a.getPositionByEvent(e).column;if(Ext.Array.contains(f.clickableCols,g)&&!Ext.isEmpty(b.data[f.columns[g].dataIndex])){Ext.get(e.target).addCls(f.overCellCls)}},onMouseLeave:function(a,b,c,d,e){var f=this,g=a.getPositionByEvent(e).column;if(Ext.Array.contains(f.clickableCols,g)&&!Ext.isEmpty(b.data[f.columns[g].dataIndex])){Ext.get(e.target).removeCls(f.overCellCls)}},columnRenderer:function(a,b){b.tdAttr='data-qtip="'+a+'"';return a},formatPrice:function(a){if(a>=1e4){a=a/1e3;var b=a%1;if(b!==0&&b!==.5){a=a.toFixed(2)}a+="k";a=a.replace(".00","")}return a},openMap:function(a){var b=this,c=a.split(" ")[1].split(","),d=Ext.create("Ext.util.MixedCollection"),e;b.store.each(function(a){var b=a.get("VendorName"),c=a.get("Location").split(" ")[1].split(",");e=b+c.toString();if(!d.contains(e)){d.add(e,{name:a.get("VendorName"),lat:Ext.Number.from(c[0],0),lon:Ext.Number.from(c[1],0)})}});if(!b.win){b.win=Ext.create("MapWindow",{lat:Ext.Number.from(c[1],0),lon:Ext.Number.from(c[0],0),locs:d})}else{b.win.lat=Ext.Number.from(c[1],0);b.win.lon=Ext.Number.from(c[0],0);b.win.locs=d;b.win.updateCenter();b.win.updateLocs()}b.win.show()}});Ext.onReady(function(){Ext.QuickTips.init();Ext.create("Ext.container.Viewport",{layout:"fit",componentCls:"vendor-grid-vp",items:{xtype:"vendorgrid"}})})